<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- CSP is set via webpack-dev-server headers and Electron session.webRequest -->
    <!-- This meta tag is only a fallback and will be overridden by server headers in dev mode -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:* ws://localhost:* https://fonts.googleapis.com https://fonts.gstatic.com; script-src 'self' http://localhost:* ws://localhost:* 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' http://localhost:* https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:* ws://localhost:* https://graph.microsoft.com https://login.microsoftonline.com;" />
    <title>SysCat - M365 Admin Autopilot</title>
    <!-- Critical polyfills - MUST run synchronously before webpack-dev-server client -->
    <!-- webpack-dev-server injects its client code at runtime, so this must be inline -->
    <script>
      (function() {
        'use strict';
        
        console.log('[SysCat] Initializing critical polyfills before webpack-dev-server client...');
        
        // Global polyfill
        if (typeof global === 'undefined') {
          window.global = globalThis;
        }
        
        // Process polyfill
        if (typeof process === 'undefined') {
          window.process = { 
            env: { NODE_ENV: 'development' },
            nextTick: function(cb) { setTimeout(cb, 0); },
            version: '',
            versions: {},
            platform: 'browser'
          };
        }
        
        // EventEmitter polyfill - must be a proper constructor
        // This MUST be available before webpack-dev-server client code runs
        function EventEmitter() {
          if (!(this instanceof EventEmitter)) {
            return new EventEmitter();
          }
          this._events = Object.create(null);
        }
        
        EventEmitter.prototype.on = function(event, listener) {
          if (!this._events[event]) {
            this._events[event] = [];
          }
          this._events[event].push(listener);
          return this;
        };
        
        EventEmitter.prototype.once = function(event, listener) {
          var self = this;
          var onceWrapper = function() {
            listener.apply(this, arguments);
            self.removeListener(event, onceWrapper);
          };
          onceWrapper.listener = listener;
          return this.on(event, onceWrapper);
        };
        
        EventEmitter.prototype.emit = function(event) {
          if (this._events[event]) {
            var args = Array.prototype.slice.call(arguments, 1);
            var listeners = this._events[event].slice();
            for (var i = 0; i < listeners.length; i++) {
              try {
                listeners[i].apply(this, args);
              } catch (e) {
                console.error('[EventEmitter] Error in listener:', e);
              }
            }
          }
          return this;
        };
        
        EventEmitter.prototype.removeListener = function(event, listener) {
          if (this._events[event]) {
            var index = -1;
            for (var i = 0; i < this._events[event].length; i++) {
              if (this._events[event][i] === listener || 
                  (this._events[event][i].listener && this._events[event][i].listener === listener)) {
                index = i;
                break;
              }
            }
            if (index >= 0) {
              this._events[event].splice(index, 1);
              if (this._events[event].length === 0) {
                delete this._events[event];
              }
            }
          }
          return this;
        };
        
        EventEmitter.prototype.removeAllListeners = function(event) {
          if (event) {
            delete this._events[event];
          } else {
            this._events = Object.create(null);
          }
          return this;
        };
        
        // Make EventEmitter available globally
        window.EventEmitter = EventEmitter;
        globalThis.EventEmitter = EventEmitter;
        
        // Create events module - CRITICAL: require('events') must return the EventEmitter constructor directly
        // But it also needs EventEmitter as a property for destructuring: const { EventEmitter } = require('events')
        // This matches the real Node.js events package structure
        var eventsModule = EventEmitter;
        eventsModule.EventEmitter = EventEmitter;
        
        // Set up require polyfill for events module - CRITICAL for webpack-dev-server
        // This must intercept require('events') calls before webpack-dev-server client runs
        var originalRequire = window.require;
        window.require = function(module) {
          if (module === 'events') {
            console.log('[SysCat] require("events") intercepted - returning EventEmitter constructor');
            return eventsModule;
          }
          if (originalRequire) {
            try {
              return originalRequire(module);
            } catch (e) {
              console.warn('[SysCat] require() failed for module:', module, e);
              throw e;
            }
          }
          throw new Error('Cannot find module: ' + module);
        };
        
        // Pre-populate webpack's module cache if it exists
        // This ensures webpack-dev-server client can find the events module
        if (typeof __webpack_require__ !== 'undefined') {
          if (!__webpack_require__.cache) {
            __webpack_require__.cache = {};
          }
          __webpack_require__.cache['events'] = {
            exports: eventsModule,
            loaded: true,
            id: 'events'
          };
          
          // Also set up the module factory
          if (typeof __webpack_modules__ !== 'undefined') {
            __webpack_modules__['events'] = function(module) {
              module.exports = eventsModule;
            };
          }
        }
        
        console.log('[SysCat] EventEmitter polyfill initialized successfully');
        console.log('[SysCat] EventEmitter constructor available:', typeof EventEmitter === 'function');
        console.log('[SysCat] window.EventEmitter available:', typeof window.EventEmitter === 'function');
      })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>

